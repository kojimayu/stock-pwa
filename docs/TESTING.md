# テスト一覧・説明ドキュメント

テストスイート全70ケース（7ファイル）の一覧です。

> **⚠️ 重要:** 機能の変更や追加があった場合、対応するテストも変更・追加し、このドキュメントも更新してください。

## 実行方法

```bash
npm test
```

> テスト用DB（`prisma/test-vitest.db`）が自動作成されます。本番DBには影響しません。

---

## テストファイル構成

### 1. 認証テスト (`__tests__/actions/auth.test.ts`) — 10ケース

**verifyPin — PIN認証**

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | ✅ 正常: 正しいPINで認証できる | 正しいPINで `success: true` |
| 2 | ❌ 異常: 間違ったPINは認証失敗 | 誤PINで `success: false` |
| 3 | ❌ 異常: 存在しないユーザーIDで失敗 | 架空IDで `success: false` |
| 4 | 📋 仕様確認: 無効化業者の動作記録 | isActiveチェック未実装を記録（TODO） |

**changePin — PIN変更**

| # | テスト名 | 内容 |
|---|---------|------|
| 5 | ✅ 正常: 4桁PINに変更できる | pinChangedがtrueになる |
| 6 | ❌ 異常: 4桁未満は失敗 | `success: false` + エラーメッセージ |
| 7 | ❌ 異常: 初期PIN(1234)への変更禁止 | `success: false` + エラーメッセージ |

**resetPin — PINリセット / createVendorUser — 担当者登録**

| # | テスト名 | 内容 |
|---|---------|------|
| 8 | ✅ 正常: PINリセットできる | pinChanged→false に戻る |
| 9 | ✅ 正常: 担当者を追加できる | VendorUserが作成される |
| 10 | ❌ 異常: 存在しない業者IDは外部キー制約で失敗 | PrismaErrorがthrowされる |

---

### 2. 取引テスト (`__tests__/actions/transaction.test.ts`) — 8ケース

**createTransaction — 部材チェックアウト**

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | ✅ 正常: 在庫内数量で持出しできる | 在庫が減りTransactionが作成される |
| 2 | ❌ 異常: 在庫超過で失敗 | `success: false` |
| 3 | ❌ 異常: 在庫0の商品は持出せない | `success: false` |
| 4 | ✅ 正常: 手入力商品は在庫チェックスキップ | isManual=trueで在庫0でも成功 |
| 5 | ✅ 正常: 複数商品を同時チェックアウト | 1トランザクションで複数商品処理 |

**createReturnFromHistory — 履歴からの返品**

| # | テスト名 | 内容 |
|---|---------|------|
| 6 | ✅ 正常: 返品で在庫が回復する | 在庫数が元に戻る |
| 7 | ❌ 異常: 購入数を超える返品は失敗 | 上限チェックエラー |
| 8 | ❌ 異常: 存在しないトランザクションは失敗 | エラー処理の動作確認 |

---

### 3. 在庫テスト (`__tests__/actions/stock.test.ts`) — 9ケース

**adjustStock — 部材の在庫手動調整**

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | ✅ 正常: 在庫を増やせる（入庫） | stock: 5 → IN:3 → 8 |
| 2 | ✅ 正常: 在庫を減らせる（出庫） | stock: 10 → OUT:4 → 6 |
| 3 | ❌ 異常: 在庫を超える出庫はエラー | 在庫不足でthrow、在庫不変 |
| 4 | ✅ 正常: InventoryLogに記録される | 調整履歴がDBに保存される |

**棚卸し — InventoryCount（部材用）**

| # | テスト名 | 内容 |
|---|---------|------|
| 5 | ✅ 正常: 棚卸しセッションを開始できる | status=IN_PROGRESS |
| 6 | ❌ 異常: 進行中の棚卸しがあれば新規開始不可 | 重複開始ガード |
| 7 | ✅ 正常: 棚卸しをキャンセルできる | status→CANCELLED |

**エアコン在庫（DBレベル確認）**

| # | テスト名 | 内容 |
|---|---------|------|
| 8 | ✅ 正常: エアコン商品を正しく作成できる | stock, codeが正しい |
| 9 | ✅ 正常: 在庫0のエアコンも存在できる | 在庫切れ状態のテスト |

---

### 4. エアコン商品テスト (`__tests__/actions/aircon-actions.test.ts`) — 7ケース

**getAirconProducts — 商品一覧取得**

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | ✅ 正常: 商品一覧を取得できる | 2件以上取得 |
| 2 | ✅ 正常: 必須フィールドが含まれる | id, code, stock, name |
| 3 | ✅ 正常: codeの昇順でソートされている | 並び順の検証 |

**checkManagementNoDuplicates — 管理番号重複チェック**

| # | テスト名 | 内容 |
|---|---------|------|
| 4 | ✅ 正常: 未登録の管理番号はfalse | hasDuplicates=false, logs空 |
| 5 | ✅ 正常: 持出し済みの管理番号はtrue | hasDuplicates=true, 業者名が返る |
| 6 | ✅ 正常: INTERNALは常にfalse | 自社在庫は重複チェック対象外 |
| 7 | ✅ 正常: 返却済みログは除外される | isReturned=trueのログは無視 |

---

### 5. エアコン発注テスト (`__tests__/actions/aircon-order.test.ts`) — 19ケース

**createAirconOrder — 発注作成**

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | ✅ 正常: 下書き発注を作成できる | status=DRAFT |
| 2 | ✅ 正常: 発注を確定できる | status→ORDERED |
| 3 | ✅ 正常: 複数商品をまとめて発注 | 2商品の発注書 |

**receiveAirconOrder — 入荷処理**

| # | テスト名 | 内容 |
|---|---------|------|
| 4 | ✅ 正常: 全数入荷で在庫加算 | status→RECEIVED, 在庫+N |
| 5 | ✅ 正常: 一部入荷 | status→PARTIAL_RECEIVED |
| 6 | ❌ 異常: 発注数超過は失敗 | 超過入荷を防止 |

**cancelAirconOrder — キャンセル**

| # | テスト名 | 内容 |
|---|---------|------|
| 7 | ✅ 正常: キャンセルできる | status→CANCELLED |

| 8-19 | その他エッジケース | 重複処理、不正データ、ステータス遷移など |

---

### 6. エアコン棚卸テスト (`__tests__/actions/aircon-inventory.test.ts`) — 11ケース

**createAirconInventory — セッション開始**

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | ✅ 正常: セッションを作成できる | status=IN_PROGRESS, note保存 |
| 2 | ✅ 正常: システム在庫がスナップショットされる | expectedStock=現在の在庫 |
| 3 | ❌ 異常: 進行中がある場合は新規作成不可 | 重複防止ガード |

**updateAirconInventoryItem — 実数更新**

| # | テスト名 | 内容 |
|---|---------|------|
| 4 | ✅ 正常: 不足差異が計算される | expected:10, actual:8, adj:-2 |
| 5 | ✅ 正常: 過剰差異が計算される | expected:3, actual:5, adj:+2 |

**completeAirconInventory — 確定**

| # | テスト名 | 内容 |
|---|---------|------|
| 6 | ✅ 正常: 確定で在庫が実数に更新される | stock=actualStock, confirmedBy記録 |
| 7 | ❌ 異常: 二重確定防止 | 完了済みの再確定は失敗 |

**cancelAirconInventory — 中止**

| # | テスト名 | 内容 |
|---|---------|------|
| 8 | ✅ 正常: 中止しても在庫は変更されない | stock不変, status=CANCELLED |

**getActiveAirconInventory / getAirconInventoryHistory — 取得**

| # | テスト名 | 内容 |
|---|---------|------|
| 9 | ✅ 正常: 進行中セッションを取得できる | null以外が返る |
| 10 | ✅ 正常: 完了後はnullになる | アクティブなし |
| 11 | ✅ 正常: 履歴を取得できる | 過去セッション一覧 |

---

### 7. バックアップ整合性テスト (`__tests__/scripts/backup.test.ts`) — 6ケース

⚠️ **重要**: このテストは毎回実行時に**自動バックアップの健全性**を検証します。

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | ✅ 存在確認 | 48時間以内のバックアップファイルがある |
| 2 | ✅ サイズ確認 | 10KB以上（空DB排除） |
| 3 | ✅ ヘッダー確認 | SQLiteファイル形式である |
| 4 | ✅ 復元確認 | Prisma経由でDB接続＋クエリ実行できる |
| 5 | ✅ テーブル確認 | Product/Vendor/AirconProduct/Transactionにアクセス可能 |
| 6 | ✅ データ確認 | 商品・業者データが存在する（空DB排除） |

> **背景**: 以前、バックアップスクリプトは動作していたがファイルに不備があり復旧できなかった事例あり。このテストで検知可能。

---

## 既知のバグ・TODO

テストコード内で発見・記録されている問題：

| ファイル | 内容 | 優先度 |
|---------|------|--------|
| auth.test.ts | 無効化業者のPIN認証を許可してしまう | 🟡 中 |

---

## テスト環境

| 項目 | 値 |
|------|-----|
| テストランナー | Vitest v4.0.18 |
| DB | SQLite（テスト専用: `prisma/test-vitest.db`） |
| セットアップ | 各テスト前にDB全テーブルクリーンアップ |
| モック | `next/cache`, `next-auth`, `@/lib/mail` をモック化 |
