# テスト一覧・説明ドキュメント

テストスイート全66ケース（7ファイル）の一覧です。

## 実行方法

```bash
npm test
```

> テスト用DB（`prisma/test-vitest.db`）が自動作成されます。本番DBには影響しません。

---

## テストファイル構成

### 1. 認証テスト (`__tests__/actions/auth.test.ts`) — 10ケース

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | PIN認証（正常） | 正しいPINでログインできる |
| 2 | PIN認証（異常：誤PIN） | 間違ったPINは失敗する |
| 3 | PIN認証（異常：存在しないID） | 架空のユーザーは失敗する |
| 4 | PIN認証（仕様確認） | 無効化業者の動作を記録 |
| 5 | 担当者登録（正常） | 業者に担当者を追加できる |
| 6 | 担当者登録（異常） | 存在しない業者IDは外部キー制約で失敗 |
| 7-10 | その他認証関連 | パスワード変更、セッション検証等 |

---

### 2. 取引テスト (`__tests__/actions/transaction.test.ts`) — 8ケース

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | チェックアウト（正常） | 在庫内数量で持出しできる |
| 2 | チェックアウト（異常：在庫超） | 在庫を超える数量は失敗 |
| 3 | チェックアウト（異常：在庫0） | 在庫0の商品は持出せない |
| 4 | 手入力商品 | 在庫チェックをスキップ |
| 5 | 複数商品同時 | 複数商品を一度に持出す |
| 6 | 返品（正常） | 返品で在庫が回復する |
| 7 | 返品（異常） | 購入数を超える返品は失敗 |
| 8 | その他 | エッジケース |

---

### 3. 在庫テスト (`__tests__/actions/stock.test.ts`) — 9ケース

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | 商品一覧取得 | 全商品を取得できる |
| 2 | 在庫調整（加算） | +方向の在庫調整 |
| 3 | 在庫調整（減算） | -方向の在庫調整 |
| 4 | 在庫調整（異常） | マイナス在庫にならない |
| 5-9 | エアコン在庫関連 | エアコン在庫の増減テスト |

---

### 4. エアコン商品テスト (`__tests__/actions/aircon-actions.test.ts`) — 3ケース

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | 商品一覧取得 | エアコン商品が取得できる |
| 2 | 必須フィールド | id, code, stock, name が存在 |
| 3 | ソート確認 | codeの昇順で並んでいる |

---

### 5. エアコン発注テスト (`__tests__/actions/aircon-order.test.ts`) — 19ケース

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | 発注作成 | 下書き発注を作成できる |
| 2 | 発注確定 | ステータスがORDEREDに変わる |
| 3 | 複数商品発注 | 複数機種をまとめて発注 |
| 4 | 入荷処理（全数） | 全商品入荷で在庫加算＋RECEIVED |
| 5 | 入荷処理（一部） | 一部入荷でPARTIAL_RECEIVED |
| 6 | 入荷処理（超過防止） | 発注数を超える入荷は失敗 |
| 7 | 発注キャンセル | CANCELLED状態になる |
| 8-19 | 各種エッジケース | 重複処理、不正データ等 |

---

### 6. エアコン棚卸テスト (`__tests__/actions/aircon-inventory.test.ts`) — 11ケース

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | セッション開始 | 棚卸セッションを作成できる |
| 2 | 在庫スナップショット | 開始時にシステム在庫が記録される |
| 3 | 重複チェック | 進行中セッションがある場合は新規作成不可 |
| 4 | 実数更新（不足） | 実数 < 予想 で差異が計算される |
| 5 | 実数更新（過剰） | 実数 > 予想 で差異が計算される |
| 6 | 確定→在庫反映 | 確定で在庫が実数に更新される |
| 7 | 二重確定防止 | 完了済みセッションの再確定は失敗 |
| 8 | 中止→在庫不変 | 中止しても在庫は変更されない |
| 9 | 進行中セッション取得 | アクティブセッションを取得できる |
| 10 | 完了後null | 完了後は進行中がnullになる |
| 11 | 履歴取得 | 過去のセッション一覧を取得できる |

---

### 7. バックアップ整合性テスト (`__tests__/scripts/backup.test.ts`) — 6ケース

⚠️ **重要**: このテストは毎回実行時に**自動バックアップの健全性**を検証します。

| # | テスト名 | 内容 |
|---|---------|------|
| 1 | 存在確認 | 48時間以内のバックアップファイルがある |
| 2 | サイズ確認 | 10KB以上（空DB排除） |
| 3 | ヘッダー確認 | SQLiteファイル形式である |
| 4 | 復元確認 | Prisma経由でDB接続＋クエリ実行できる |
| 5 | テーブル確認 | Product/Vendor/AirconProduct/Transactionにアクセス可能 |
| 6 | データ確認 | 商品・業者データが存在する（空DB排除） |

> **背景**: 以前、バックアップスクリプトは動作していたがファイルに不備があり復旧できなかった事例あり。このテストで検知可能。

---

## テスト環境

| 項目 | 値 |
|------|-----|
| テストランナー | Vitest v4.0.18 |
| DB | SQLite（テスト専用: `prisma/test-vitest.db`） |
| セットアップ | 各テスト前にDB全テーブルクリーンアップ |
| モック | `next/cache` の `revalidatePath` をモック化 |
