# 実装完了：Kioskログイン不具合解消と本番環境の構築

## 実施した主な変更

### 1. アプリケーションのフリーズ・リセット対策
- **Hot Reloadの停止**: データベースの書き込みをNext.jsが「コード変更」と誤認して画面をリロードさせていた問題を、`next.config.ts` の監視対象外設定により解消しました。
- **SQLite WALモード有効化**: 読み書きの競合を避けるため、高速な同時実行モードに変更しました。
- **ログ処理の最適化**: ログイン時の不要なセッションチェックをスキップし、処理速度を大幅に向上させました。

### 2. 本番用ビルド（Production Mode）の整備
- **`npm run start` の修正**: タブレットから外部アクセスできるよう `-H 0.0.0.0` を追加しました。
- **ビルドエラーの解消**: Next.js 16のTurbopack競合（`--webpack` フラグ）と、補助スクリプトの型エラーを修正しました。

### 3. 自動テスト環境の導入
- **Playwrightの導入**: ログインフローを自動検証する環境を構築しました。

## 運用マニュアル（停止と再起動）

### サーバーを停止する場合
ターミナル上で **`Ctrl + C`** を押してください。

### 再起動する場合
1.  **通常（プログラム変更なし）**:
    ```bash
    npm run start
    ```
2.  **新機能追加や修正を行った後**:
    一度ビルドし直す必要があります。
    ```bash
    npm run build
    npm run start
    ```

## ダッシュボードの改善 (2026-02-16)

### 在庫アラート判定の厳格化
ユーザーフィードバックに基づき、ダッシュボードの「在庫アラート」のロジックを調整しました。

**変更前:**
- 在庫数 <= 最低在庫数 でアラート表示（黄色）
- 例: 最低在庫1個の設定で、在庫が1個ある場合もアラートが出ていた。

**変更後:**
- **在庫数 < 最低在庫数** （未満）でアラート表示
- 例: 最低在庫1個の設定で、在庫が1個あればアラートは出ない。在庫が0個になった時点でアラートが出る。

### 発注済み商品の除外
「既に発注手配済みなのにアラートが出続けて目障り」という意見に基づき、以下の条件に合致する商品は**在庫アラートから除外**するようにしました。
- 注文ステータスが **「発注済 (ORDERED)」** または **「一部入荷 (PARTIAL)」** の注文に含まれている商品

これにより、最低在庫ギリギリで運用しているニッチな商品や、手配済みの商品がアラート表示されるノイズを防ぎ、本当に補充が必要なタイミングでのみ警告が出るようになりました。
「在庫切れ（0個）」のアラート（赤色）は従来通り最優先で表示されます。

---

## エアコン管理: 予備（自社在庫）持ち出し機能 (2026-02-16)
「管理Noが決まっていない物件用のエアコンを、予備として自社倉庫に確保しておきたい」という要望に対応しました。

### 機能概要
- **Kiosk画面**: エアコン持ち出し画面に「管理Noなし（予備・自社在庫）として登録」ボタンを追加。
    - 押下すると管理No入力が不要になり、即座に機種選択へ進めます。
- **管理画面**: エアコン持出し履歴で、管理Noが「INTERNAL」の場合に **「自社在庫」** バッジを表示します。

### 運用フロー
1. 業者がKioskで「自社在庫モード」を選択し、予備エアコンを持ち出し（確保）。
2. 後日、案件が決まったら、管理画面で履歴を確認し、「戻す（在庫に戻す）」処理を行ってから、再度正しい管理Noで持ち出し直す運用となります。

---
> [!IMPORTANT]
> 日常的な運用（朝の立ち上げなど）では、**`npm run start`** だけで問題ありません。

---

## 業者持出在庫の統合と定義変更 (2026-02-18)
これまでの「業者用予備在庫ダッシュボード」を廃止し、**「在庫管理」画面に機能を一本化**しました。

### 1. 在庫一覧の表示強化
- **3つの在庫数を表示**:
    - **倉庫在庫**: 社内倉庫にある数。
    - **業者持出**: 予備として業者が持ち出している数（管理番号なし）。
    - **総在庫**: 上記の合計（会社全体の資産）。
- **内訳の見える化**: 「業者持出」の数字をクリックすると、どの業者が何台持っているか即座に確認できます。

### 2. データ定義の変更（システム内部）
- **管理番号の任意化**: 予備在庫として持ち出す際、管理番号（`managementNo`）を必須ではなく「空（NULL）」で登録できるように変更しました。
- **データ移行**: 以前の仕様で「INTERNAL」という文字列で管理されていた予備在庫データを、新しい「空（NULL）」形式に自動変換しました。
- **紐付け修正**: データ移行に伴い、商品情報との紐付けが切れていた過去の予備在庫データ（RAS-AJシリーズ等）を復旧させました。

### 3. テストデータのクリーンアップ
- 「テスト小島」などの検証用データを削除し、検証で持ち出されていた在庫を倉庫に戻す処理を行いました。

### 画面表示と検証環境の改善 (2026-02-18)
1. **検証環境のログイン修正**: 本番データのコピーに不備があり、検証環境(`test.db`)でPIN再設定や業者一覧表示に問題が発生していた点を修正しました。
2. **部材履歴の単位表示**: インボイス対応で部材の出荷履歴を確認する際、「個」なのか「箱」なのかがわかるよう、履歴一覧に単位を表示するようにしました。
3. **Kioskタブレット対応**: 
    - **カート配置**: ユーザーフィードバックに基づき、iPad等のタブレットでも**カート（右サイドバー）を常時表示**するように戻しました。これにより、選択した商品が常に確認できます。
    - **カテゴリー開閉**: 商品一覧の表示領域を確保するため、左側の**カテゴリーリストをボタン一つで開閉（折りたたみ）可能**にしました。
    - **レスポンシブ**: モバイル時は従来通りカートはフッター収納、カテゴリーはタブ切り替えとなります。

### Vitest単体テスト基盤の構築 (2026-02-19)
1. **テストインフラ**: Vitest v4.0.18をインストールし、`vitest.config.ts`を作成。テスト専用DB (`test-vitest.db`) を使用して開発DB (`test.db`) と完全分離。
2. **テストヘルパー**: `__tests__/setup/` にグローバルセットアップ（DB初期化）とファクトリ関数（Vendor, VendorUser, Product, AirconProduct作成）を整備。
3. **単体テスト**: 3ファイル 27テスト全通過
    - `auth.test.ts` (10テスト): PIN認証・変更・リセット・担当者登録
    - `transaction.test.ts` (8テスト): チェックアウト・在庫チェック・棚卸し中制限・返品
    - `stock.test.ts` (9テスト): 在庫調整・棚卸し・エアコン在庫
4. **🐛 バグ発見**: `adjustStock` 関数がOUT（出庫）時にもstockを加算してしまう重大バグを検出。`increment: quantity` が常に正数で適用されるため。修正はTODOとして記録。
