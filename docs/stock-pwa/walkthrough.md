# エアコン管理機能実装とKiosk UI改善 (2026-02-02)

## 概要
エアコンの発注・在庫・持出し管理を行うための包括的な機能を実装しました。また、現場で使用するKioskアプリのエアコン持出し画面をタブレット操作に最適化しました。

## 実装機能

### 1. 管理画面 (Admin)

#### 在庫管理 (`/admin/aircon-inventory`)
- **4品目管理**: RAS-AJ22, RAS-AJ25, RAS-AJ28, RAS-AJ36
- **サフィックス個別設定**: 発注時の年度コード（N, M等）を機種ごとに設定可能。
- **在庫調整**: 手動での在庫数増減に対応。
- **アラート**: 最低在庫数を下回るとアラート表示。

#### 発注管理 (`/admin/aircon-orders`)
- **発注作成**: 機種ごとのサフィックスを付与して発注書（データ）を作成。
- **ステータス遷移**: 下書き → 発注済 → 一部入荷 → 入荷完了。
- **入荷処理**: 入荷数を入力し、自動で在庫に加算。

#### ログ・戻し機能 (`/admin/aircon-logs`)
- **持出し履歴**: 管理No、業者、日付でのフィルタリング。
- **戻し機能**: 間違って持出した履歴を「戻す」ことで、記録を更新し**在庫を自動復元**。

### 2. 現場用アプリ (Kiosk)

#### エアコン持出し画面 (`/aircon`)
- **タブレット最適化レイアウト**:
    - 画面を左右2カラムに分割し、スクロールなしで操作完結。
    - **左側**: 管理No検索入力、物件詳細情報表示。
    - **右側**: 持出しリスト（カート）、ワンプッシュ機種選択ボタン、持出し確定ボタン。
- **視認性向上**:
    - 削除ボタンをゴミ箱アイコンに変更。
    - 確定ボタンを大きく緑色にし、押しやすさを改善。
    - 物件情報がない状態では右側をグレーアウトして誤操作防止。

## 技術的変更点

### データベース (Prisma)
- `AirconProduct`: `suffix` カラムを追加し、機種ごとのデフォルトサフィックスを保持。
- `AirconOrder`, `AirconOrderItem`: 発注管理用のモデルを追加。
- `SystemSetting`: システム全体の設定値（初期サフィックス等）用に追加。
- `AirConditionerLog`: `isReturned`, `returnedAt`, `airconProductId` を追加し、在庫連動を実現。

### API / Server Actions
- `lib/aircon-actions.ts`: 在庫操作、発注処理、サフィックス更新等のロジックを集約。
- `lib/actions.ts`: 一般部材用の `returnTransaction` を追加。
- 取引API (`/api/aircon/transaction`): トランザクション内でログ作成と在庫減算を原子的に実行。

## 完了した項目
1. エアコン管理機能一式
2. Kiosk UI改善
3. 部材（材料）の戻し機能
   - 取引履歴一覧の「戻す」ボタン（Undoアイコン）を押すとダイアログが開きます。
   - **一部戻し対応**: 各商品ごとに戻す数量を指定可能。
   - 実行すると:
     - 在庫が指定数だけ復元（InventoryLog: "返品"）。
     - 取引履歴の数量・金額が減算（訂正）。
     - 全て戻された場合は `isReturned` フラグが立ち、「戻し済」表示になります。

4. 商品選択画面のUI改善
   - **リスト形式**: 一覧性を重視し、コンパクトなリスト表示に変更。
   - **2段階カテゴリ**: 「大カテゴリ」選択後に「中カテゴリ」ボタンで絞り込み可能。
   - **人気順ソート**: よく使われる（取引回数の多い）商品が上位に表示されるロジックを追加（`usageCount`）。
   - **数量入力**: 商品タップでポップアップ入力（従来の使用感を維持）。

5. UIレイアウト最適化
   - **サイドバー**: PC/タブレット等の横長画面では、カテゴリ一覧を左サイドバーに固定配置し、スペースを有効活用。
   - **手入力改善**: 画面を覆う大きなダイアログから、右側からスライドするパネル（Sheet）に変更し、商品リストを見ながら入力可能に修正。トリガーもリスト内のアイテム化。

6. 3カラムレイアウト＆手入力調整
   - **3カラム構成**: PC/タブレット横持ち時、「大カテゴリ｜小カテゴリ｜商品一覧」の3列表示に変更。
   - **手入力ボタン配置**: 左サイドバーの最下部（デッドスペース）に配置し、商品リストを邪魔しないように調整。
   - **キーボード対策**: 手入力シート内のフォームを上部に配置し、ソフトウェアキーボードで隠れないように改善。

7. UIブラッシュアップ
   - **金額非表示**: ルールに基づき、全画面（一覧、手入力、カート）から金額表示を完全に削除。
   - **手入力改善**: 商品名入力欄のプレースホルダーに詳細記入を促す文言を追加。トリガーボタンを大型化し、下部余白を追加して操作性を向上。

### 8. Kiosk UI/UX改善と履歴機能 (2026-02-02追記)
- **UI改善**:
    - 全画面のヘッダーにベンダー名を表示しデザインを統一。
    - 「戻る」ボタンを追加し、材料出庫とエアコン出庫のモード間遷移をスムーズに。
    - 通知（Toaster）の位置を上部に変更し、操作ボタンとの重なりを解消。
- **エアコン履歴機能**:
    - **履歴閲覧**: 自身の直近のエアコン持出し履歴を確認可能に。
    - **履歴修正**: 管理Noや顧客名の誤りをその場で修正可能に。
    - **戻し表示改善**: 差し戻されたアイテムは削除せず、グレーアウト・打消し線・「戻し済」バッジで明示的に無効であることを表示。
