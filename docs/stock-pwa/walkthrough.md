# 実装完了：Kioskログイン不具合解消と本番環境の構築

## 実施した主な変更

### 1. アプリケーションのフリーズ・リセット対策
- **Hot Reloadの停止**: データベースの書き込みをNext.jsが「コード変更」と誤認して画面をリロードさせていた問題を、`next.config.ts` の監視対象外設定により解消しました。
- **SQLite WALモード有効化**: 読み書きの競合を避けるため、高速な同時実行モードに変更しました。
- **ログ処理の最適化**: ログイン時の不要なセッションチェックをスキップし、処理速度を大幅に向上させました。

### 2. 本番用ビルド（Production Mode）の整備
- **`npm run start` の修正**: タブレットから外部アクセスできるよう `-H 0.0.0.0` を追加しました。
- **ビルドエラーの解消**: Next.js 16のTurbopack競合（`--webpack` フラグ）と、補助スクリプトの型エラーを修正しました。

### 3. 自動テスト環境の導入
- **Playwrightの導入**: ログインフローを自動検証する環境を構築しました。

## 運用マニュアル（停止と再起動）

### サーバーを停止する場合
ターミナル上で **`Ctrl + C`** を押してください。

### 再起動する場合
1.  **通常（プログラム変更なし）**:
    ```bash
    npm run start
    ```
2.  **新機能追加や修正を行った後**:
    一度ビルドし直す必要があります。
    ```bash
    npm run build
    npm run start
    ```

## ダッシュボードの改善 (2026-02-16)

### 在庫アラート判定の厳格化
ユーザーフィードバックに基づき、ダッシュボードの「在庫アラート」のロジックを調整しました。

**変更前:**
- 在庫数 <= 最低在庫数 でアラート表示（黄色）
- 例: 最低在庫1個の設定で、在庫が1個ある場合もアラートが出ていた。

**変更後:**
- **在庫数 < 最低在庫数** （未満）でアラート表示
- 例: 最低在庫1個の設定で、在庫が1個あればアラートは出ない。在庫が0個になった時点でアラートが出る。

### 発注済み商品の除外
「既に発注手配済みなのにアラートが出続けて目障り」という意見に基づき、以下の条件に合致する商品は**在庫アラートから除外**するようにしました。
- 注文ステータスが **「発注済 (ORDERED)」** または **「一部入荷 (PARTIAL)」** の注文に含まれている商品

これにより、最低在庫ギリギリで運用しているニッチな商品や、手配済みの商品がアラート表示されるノイズを防ぎ、本当に補充が必要なタイミングでのみ警告が出るようになりました。
「在庫切れ（0個）」のアラート（赤色）は従来通り最優先で表示されます。

---

## エアコン管理: 予備（自社在庫）持ち出し機能 (2026-02-16)
「管理Noが決まっていない物件用のエアコンを、予備として自社倉庫に確保しておきたい」という要望に対応しました。

### 機能概要
- **Kiosk画面**: エアコン持ち出し画面に「管理Noなし（予備・自社在庫）として登録」ボタンを追加。
    - 押下すると管理No入力が不要になり、即座に機種選択へ進めます。
- **管理画面**: エアコン持出し履歴で、管理Noが「INTERNAL」の場合に **「自社在庫」** バッジを表示します。

### 運用フロー
1. 業者がKioskで「自社在庫モード」を選択し、予備エアコンを持ち出し（確保）。
2. 後日、案件が決まったら、管理画面で履歴を確認し、「戻す（在庫に戻す）」処理を行ってから、再度正しい管理Noで持ち出し直す運用となります。

---
> [!IMPORTANT]
> 日常的な運用（朝の立ち上げなど）では、**`npm run start`** だけで問題ありません。
