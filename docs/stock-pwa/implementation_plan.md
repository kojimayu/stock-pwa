<<<<<<< HEAD
# 入荷訂正・取消機能の実装

## 実装の目的
発注管理機能において、「間違えて入荷完了にしてしまった」「数量を間違えて登録した」というミスに対応するため、入荷処理の**取消（Undo）機能**を実装します。

## ユーザー確認事項
- 「入荷取消」を行うと、**以下の処理が一括で行われます**。
    - 発注ステータスが「入荷完了」から「一部入荷」または「下書き（発注済）」に戻ります。
    - 商品の在庫数が自動的に減算されます（入荷前の状態に戻る）。
    - 取引履歴（InventoryLog）に「取消」の記録が残ります。

## 変更内容詳細

### サーバーサイド (actions.ts)
#### [NEW] `cancelReceipt` アクション
- **引数**: OrderItemID, Quantity (取消数量)
- **処理**:
    1. 対象のOrderItemを取得し、`receivedQuantity` が十分にあるか確認。
    2. `OrderItem` の `receivedQuantity` を減算し、`isReceived` フラグを false に戻す。
    3. `Product` の在庫数 (`stock`) を減算する。
    4. `Order` のステータスを再評価して更新する（全完了でなくなれば `PARTIAL` に戻す）。
    5. `InventoryLog` に取消ログ（タイプ: `CORRECTION` または `UNDO_RECEIPT`）を記録する。

### フロントエンド (order-detail.tsx)
- 入荷済みの行リストに「取消」ボタン（または「修正」アイコン）を追加します。
- クリックすると確認ダイアログが表示され、実行すると入荷処理が取り消されます。

## 検証計画
1.  **通常入荷**: 10個発注→10個入荷（在庫+10）
2.  **取消実行**: 取消ボタン押下（在庫-10）
3.  **確認**:
    - 在庫が元の数に戻っていること
    - ステータスが「入荷完了」から戻っていること
    - 再度入荷操作が可能になっていること

# Kiosk機能強化・返品モード実装計画（Design Lead提案例）

## 1. 返品（在庫戻し）モードのUXデザイン

現場の職人さんが直感的に操作でき、かつ「間違えて戻した」ミスを防ぐデザインを提案します。

### 画面フロー
1.  **モード選択**: ログイン直後の画面で大きく「出庫（持ち出し）」と「返却（在庫戻し）」を選択させます。
    -   **出庫**: テーマカラー「青/黒」（通常）
    -   **返却**: テーマカラー**「オレンジ/赤」**等、警告色を使用して「今は戻すモードだ」と常に意識させます。
2.  **商品選択**: 操作は出庫時と同じ（学習コスト低下）。
3.  **完了画面 (The "Check" functionality)**:
    -   大きく **「返却を受け付けました」** と表示。
    -   その下に **「現在の在庫数: 〇〇個」** を大きく強調表示します。
    -   これにより、職人さんは「あ、在庫が増えたな（ちゃんと戻ったな）」と現地で確認できます。

## 2. 商品選択・検索機能のUX改善

現在「カテゴリ大区分→中区分」止まりの階層を、よりスムーズに目的の商品にたどり着けるよう改善します。

### 検索機能 (Search) & レイアウト最適化 (Landscape)
*   **配置**: 商品選択画面のヘッダー直下に「商品名で検索...」バーを常設します。
*   **横画面最適化**: タブレット横向きでの利用を前提に、無駄な余白を削減します。
    *   **グリッド表示**: 商品カードを画面幅に合わせて自動詰め込み（Responsive Grid）し、一度に多くの商品を表示します。
    *   **ヘッダーコンパクト化**: 検索バーや戻るボタンを1行に収め、商品表示エリアを最大化します。
*   **挙動**: 入力するとリアルタイム（またはEnterで）全商品から絞り込みます。カテゴリ階層を知らなくても商品に辿り着けます。

### カテゴリ小（詳細分類）のUI
*   **配置**: サブカテゴリ（中区分）を選択した後、商品リストの上に「フィルターチップ（横スクロールボタン）」を配置します。
    *   例: [ すべて ] [ 直管 ] [ 曲がり ] [ ジョイント ]
*   **挙動**: ボタンをタップすると、下部のリストがそのタイプだけで絞り込まれます。
*   **メリット**: 画面遷移を増やさず（3階層目に潜らず）、1画面内でパパッと切り替えられるため、比較検討もしやすくなります。

## 実装ステップ

1.  **Kiosk検索**: `shop/page.tsx` に検索窓を追加。
2.  **Kioskカテゴリ小**: 商品リストコンポーネントに `productType` フィルターを追加。
3.  **返品モード**: `app/mode-select` 画面の作成と、カートストア（状態管理）への `isReturnMode` フラグ追加。
4.  **完了画面**: 結果表示コンポーネントで `isReturnMode` なら在庫数を強調表示するロジック追加。

# 実装計画: 管理画面のAzure AD認証 (Admin Authentication)

## 概要
管理画面 (`/admin`) へのアクセスに Microsoft 365 アカウント (Azure Entra ID) による認証を導入します。
これにより、セキュリティを強化し、操作ログに「誰が実行したか」を正確に記録できるようにします。

## ユーザーレビューが必要な事項
> [!IMPORTANT]
> **.envの設定**
> 作成した `STOCK-PWA-Auth` アプリの情報を `.env` に設定してください。
> ```env
> AZURE_AD_CLIENT_ID="..."
> AZURE_AD_CLIENT_SECRET="..."
> AZURE_AD_TENANT_ID="..."
> NEXTAUTH_URL="http://localhost:3000"
> NEXTAUTH_SECRET="..." (ランダムな文字列)
> ```

## 変更内容

### 1. 認証基盤の実装
#### [NEW] [lib/auth.ts](file:///f:/Antigravity/stock-pwa/lib/auth.ts)
- NextAuthの設定（v5 beta or v4 compatible configuration for Next.js 14/15）。
- `AzureADProvider` を使用。
- セッションコールバックで `user.id` や `email` を保持。

#### [NEW] [app/api/auth/[...nextauth]/route.ts](file:///f:/Antigravity/stock-pwa/app/api/auth/[...nextauth]/route.ts)
- 認証ハンドラのエンドポイント。

#### [NEW] [middleware.ts](file:///f:/Antigravity/stock-pwa/middleware.ts)
- `/admin` 以下のルートを保護。
- 未認証なら `/login` またはMicrosoftログインへリダイレクト。

### 2. UI/UXの変更
#### [MODIFY] [app/(admin)/layout.tsx](file:///f:/Antigravity/stock-pwa/app/(admin)/layout.tsx)
- サイドバー下部に「ログアウト」ボタンと「ログイン中のユーザー名」を表示。

#### [NEW] [app/login/page.tsx](file:///f:/Antigravity/stock-pwa/app/login/page.tsx)
- (Option) カスタムログイン画面を作るか、NextAuth標準画面を使用。まずは標準画面またはダイレクトログインで進める。

### 3. 操作ログへの記録
#### [MODIFY] [lib/actions.ts](file:///f:/Antigravity/stock-pwa/lib/actions.ts)
- `logOperation` 関数内で `getServerSession` を呼び出し、現在のユーザーメールアドレスを取得して `details` に追記（またはカラム追加）。

## 検証計画
1.  `.env` 設定後、`/admin` にアクセスしてログイン画面が出るか。
2.  Microsoftアカウントでログインした後、管理画面に入れるか。
3.  操作（商品更新など）を行った際、ログにメールアドレスが残るか。

# 代理入力データの消失バグ修正

## 概要
代理入力モードで商品を選択中に、画面がリフレッシュされたりバックグラウンドでの再検証が発生すると、入力したカートの内容がすべて消えてしまう問題を修正します。

## 原因
`ProxyShopContent` 内の `useEffect` において、`vendor` オブジェクトが依存配列に含まれており、マウント時や `vendor` オブジェクトのリファレンスが変わるたびに `clearCart()` が実行されているため。サーバーコンポーネントからの再マウント時にリファレンスが新しくなり、意図せずクリアされている。

## 修正内容
- `clearCart()` の実行タイミングを、本当に業者が切り替わった時のみに制限する。
- または、`ProxyInputClient` 側で「入力を開始」ボタンを押した時のみクリアするように変更する。

## 検証
1. 代理入力で商品を追加する。
2. ページをリロードする。
3. カートの内容が保持されていることを確認する。
