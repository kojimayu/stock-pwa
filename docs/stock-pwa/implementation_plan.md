# 箱単位販売ロジックの実装計画 (実装完了)

## 概要
ユーザーからの要望により、商品を「箱（ケース）」単位で販売、管理、発注できる機能を実装しました。
在庫は「個 (Unit)」単位で統一して管理し、箱販売時は「箱入数」分を自動的に減算します。

## 実装内容

### 1. データベーススキーマ (`prisma/schema.prisma`)
- [x] `Product` モデルにフィールド追加
    - `manufacturer`: String? (メーカー名)
    - `quantityPerBox`: Int (箱入数, default: 1)
    - `pricePerBox`: Int (箱単価, default: 0)
    - `orderUnit`: Int (発注単位, default: 1)

### 2. Admin機能 (`components/admin/`)
- [x] **商品登録・編集ダイアログ**: 上記フィールドの入力フォーム追加。
- [x] **Excelインポート/エクスポート**: 上記フィールドの対応（日本語ヘッダー対応）。
    - 既存商品の `code` が変更されても `id` で追跡して更新できるようにロジック改善。

### 3. Kiosk機能 (`components/kiosk/`, `lib/store.ts`)
- [x] **Cart Store**: `CartItem` に `isBox`, `quantityPerBox` フラグ追加。
- [x] **商品選択 (QuantitySelectorDialog)**:
    - [x] 「バラ」「箱」切り替えタブの実装。
    - [x] 箱選択時の価格・在庫表示切り替え。
    - [x] 最大購入可能数の計算ロジック（箱在庫 = 総在庫 / 箱入数）。
- [x] **カート表示 (CartList)**:
    - [x] 箱購入時にバッジ「箱 (XX個入)」を表示。
    - [x] 数量変更・削除が箱単位で動作することを確認。

### 4. バックエンドロジック (`lib/actions.ts`)
- [x] **取引作成 (`createTransaction`)**:
    - `isBox` フラグがある場合、`quantity * quantityPerBox` を計算して在庫から減算。
    - Inventory Log に `(Box)` と記録。
- [x] **返品処理 (`returnTransaction`)**:
    - 箱単位の返品時、正しい個数を在庫に戻すロジック実装。

## 検証結果 (Verification)

### 自動テスト / ビルドチェック
- [x] `npm run build` 相当の型チェック (TSエラーなしを確認)
- [x] Prisma Client 生成 (Schema変更適用確認)

### 手動検証シナリオ
1. **管理画面**
   - [x] 商品「テスト商品」を作成（箱入数: 10, 箱単価: 1000円, バラ単価: 120円）。
   - [x] CSV/Excelエクスポートし、データが含まれていることを確認。

2. **Kiosk画面**
   - [x] テスト商品をタップし、ダイアログで「箱」を選択。
   - [x] 価格が1000円になっていることを確認。
   - [x] カートに入れ、バッジが表示されることを確認。
   - [x] 決済を実行。

3. **データ確認**
   - [x] 在庫が10個減っていることを確認。
   - [x] 取引履歴に「箱」購入として記録されていることを確認。
   - [x] 取引履歴から返品を行い、在庫が10個戻ることを確認。
