# フィードバック・改善メモ

使用中に気づいた改善点をここに記録してください。
優先度が高いものには `[!]` を付けてください。

> **AIへの指示**: 新しい会話開始時に、このファイルの「未対応」セクションを確認して
> 作業予定を提案すること。

---

## 未対応（優先度順）

###  最優先（データ損失リスク・業務停止回避）
- [!] **オフライン対策の強化**: オフライン検知（`offline-alert.tsx`）は実装済みだが、棚卸中の専用ハンドリング（未送信データの保護・警告）はまだ未対応。


- [x] **Kioskヘッダー表示改善**: 作業モード選択画面やヘッダーで、会社名だけでなく担当者名も表示する。

### ⚠️ 優先（UX・操作性改善）
- [!] **同義語・別名検索の対応**: 同じ商品でも呼び方が異なる場合（例: VVF＝VA）やカテゴリ名（例:「電線」）でも検索できるようにエイリアス対応を検討する。
- [x] **数量入力の改善**: 50個などを入力する際、+ボタン連打は非効率。直接入力または「+5」「+10」ボタンを追加する。（※2026-02-10 タブレット向けUIで実装済み）
- [!] **カート内カテゴリ表示**: カートや確認画面で、カテゴリー・サブカテゴリーを表示して商品間違いを防ぐ。
- [!] **業者のPIN登録/ログインの遅延**: 登録時やログイン時に関数が「もっさり」したり、更新されない場合がある。原因を調査しパフォーマンスを改善する。
- [!] **接続エラーの誤検知**: 画面更新時などに「接続が切れました」等のエラーが出ることがある。判定ロジック（現在は5秒？）を調整して誤検知を減らす。
- [!] **在庫推移の可視化（時系列台帳）**: 今回の調査のように、いつ何個増減したかをグラフと表で追える機能。不整合の早期発見と原因特定のため、「在庫台帳」画面を実装する。

- [!] **大量数量の入力改善**: ±10ボタンは実装済み（`quantity-selector-dialog.tsx`）。残課題: 数値の直接入力（テンキー）対応、代理入力画面での同等対応。

### 📝 機能追加・改善
- **エアコン持出し履歴の表示**: 差し戻された案件が履歴に残って紛らわしい。「差戻」ステータスを明示するか、履歴から除外する。
- ~~**ログの抑制**~~: ✅ `next.config.ts` で `/api/health` を除外設定済み。
- ~~**PINリセット機能**~~: ✅ 管理画面の業者管理から担当者のPINリセットが可能（`vendor-list.tsx`）。
- **マニュアル閲覧機能**:
  - 管理画面から `MANUAL_ADMIN.md` を閲覧可能にする
  - Kiosk画面から `MANUAL_VENDOR.md` を閲覧可能にする
- **材料在庫連携**: 材料引取で登録した主要4品目を在庫管理と連動させる。
- **Access連携**: 代表メールアドレスを活用する。
- **棚卸中の管理画面**: 業者端末は禁止だが管理画面は使用可能でよいかの検討。
- **エアコン在庫の分離**: 室内機/室外機を別々に持ち出し・返却できる運用への対応。
- [!] **エアコンの棚卸機能**: 現在の「在庫調整」ボタンによる場当たり的な変更ではなく、毎月の棚卸として実在庫を数え、理論在庫との差異（過不足）を理由とともに記録する「棚卸機能」を実装し、厳格な在庫管理ができるようにする。
- **発注管理機能**: 現状は材料・エアコン共に未実装（データベースのみ）。発注書作成→入荷検品→在庫反映の一連のフローを実装する必要がある。
- **操作ログの検索機能**: ログが増えてきたため、日付や操作内容でフィルタリング・検索できるようにしたい。
- [!] **中途半端な材料の返却対応**: ペアコイル(1巻20m)や電線などで、一部(10mなど)を使用して残りを返却するイレギュラーなケースに対応する。現在は「1巻持ち出し」で処理されるため在庫がズレてしまう。「使用分のみ確定」や「返却処理」機能の検討が必要。
- [!] **業者による返品処理**: 現場から持ち帰った未使用品などを業者が返品できる機能。返品時に現在の在庫数と合っているかを確認させるフロー（在庫棚卸も兼ねる）を実装する。
- [ ] **ログインセッションの記録**: 現在はネットワーク内での利用が前提だが、複数端末での利用を想定し、ログイン時にセッションIDや端末識別子（Cookie/Local Storage等）を記録して、どの端末での操作か（ログイン～ログアウトの流れ）をログで追跡できるようにする。
- [ ] **クラウド移行の検討**: デプロイ計画書（docs/stock-pwa/cloud_deployment_plan.md）に基づき、コストと運用負荷を考慮して移行タイミングを検討。当面は「方式A（ローカル+バックアップ強化）」による低コスト運用を推奨。

---

## 対応済み

- ✅ 取引履歴に代理入力バッジ表示（紫色「代理入力」）
- ✅ 商品ごとに代理入力バッジ表示（紫色「代」）
- ✅ 業者選択：テスト業者を最後、よく使う業者を上に表示
- ✅ 価格修正機能（履歴から修正、理由記録、全管理者へメール通知）
- ✅ バックアップ/復旧ドキュメント（docs/BACKUP_RECOVERY.md）
- ✅ 業者有効/無効チェックボックス（Kioskには有効業者のみ表示）
- ✅ 担当者（VendorUser）階層化
- ✅ 担当者の自己登録機能
- ✅ 業者管理の検索クリアボタン追加
- ✅ 新規登録の名前フォント拡大
- ✅ ログの抑制: `next.config.ts` で `/api/health` を除外設定済み
- ✅ PINリセット機能: 管理画面 > 業者管理から担当者PINリセット可能
- ✅ 数量入力の改善: タブレット向けUI実装（±10ボタン、4桁対応）
- ✅ オフライン検知基盤: `offline-alert.tsx` + `checkout-button.tsx` で検知・警告表示済み
- ✅ クリップボードコピー: HTTP環境でのフォールバック実装済み
- ✅ 発注書の項目削除: DRAFT状態の発注から商品を個別削除可能
- ✅ 検索ロジックの共通化: `lib/utils.ts` の `normalizeForSearch` に統一（全8ファイル対応）
- ✅ 発注コピーに品番追加: `[品番] 商品名 × 数量単位` 形式でコピー可能に
- ✅ ログインスピナー修正: setTimeout+asyncのレースコンディション解消、5秒フォールバック追加
- ✅ 確認画面の0件表示バグ修正: Zustand persistのhydration完了までローディング表示に変更
- ✅ **Kioskカートの常時表示**: PC/タブレットで3カラムレイアウト化し、カートを右側に固定表示
- ✅ **数量ロジック・表示改善**:
  - +10ボタンの挙動改善（1→10、以降+10）
  - VVF/IV線の「巻」自動判定と表示
  - 「合計点数」を「商品種類数」に変更し、個数と箱数の混在による混乱を解消
  - VVF/IV線の「巻」自動判定と表示
  - 「合計点数」を「商品種類数」に変更し、個数と箱数の混在による混乱を解消
- ✅ **ExcelインポートのID対応 & ハイフン許容**: 
  - インポート時に「ID」列がある場合、IDで商品を特定して更新。
  - **ハイフン対応**: `AP-200-I` のようにハイフン付きで登録可能にしました。
  - **重複防止**: 登録時にハイフンを除去した状態で既存商品（`AP200I`など）と照合し、重複があれば新規作成せず更新します。
- ✅ **ログ機能強化**:
  - `AUTO_LOGOUT`: 自動ログアウト（スリープ復帰時含む）※担当者名も記録
  - `LOGOUT`: 手動ログアウト ※担当者名も記録
  - `ADMIN_LOGIN`: 管理画面ログイン
  - `LOGOUT`: 手動ログアウト ※担当者名も記録
  - `ADMIN_LOGIN`: 管理画面ログイン
  - `LOGIN`: Kiosk PINログイン
  - **ログフォーマット統一**: 会社名＋担当者名に対象を統一




