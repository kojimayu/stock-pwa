# フィードバック・改善メモ

使用中に気づいた改善点をここに記録してください。
優先度が高いものには `[!]` を付けてください。

> **AIへの指示**: 新しい会話開始時に、このファイルの「未対応」セクションを確認して
> 作業予定を提案すること。

---

## 未対応（優先度順）

### 🔴 最優先（データ損失リスク・業務停止回避）
- [!] **オフライン対策の強化**: オフライン検知（`offline-alert.tsx`）は実装済みだが、棚卸中の専用ハンドリング（未送信データの保護・警告）はまだ未対応。

### 🟠 優先（UX・操作性改善）
- [!] **同義語・別名検索の対応**: 同じ商品でも呼び方が異なる場合（例: VVF＝VA）やカテゴリ名（例:「電線」）でも検索できるようにエイリアス対応を検討する。
- [ ] **管理番号の重複チェック**: 管理番号(`managementNo`)に紐づけたエアコンの持出しを重複してできないようにする（バリデーション追加）。
- [ ] **入荷済みの取り消し機能**: 入荷チェックで誤って入荷確定した場合に取り消しできる仕組み。エアコン・材料両方で必要。
- [ ] **在庫破棄・調整機能**: 故障や紛失などで在庫を減らす機能がないため、追加が必要。
- [!] **カート内カテゴリ表示**: カートや確認画面で、カテゴリー・サブカテゴリーを表示して商品間違いを防ぐ。
- [!] **業者のPIN登録/ログインの遅延**: 登録時やログイン時に関数が「もっさり」したり、更新されない場合がある。原因を調査しパフォーマンスを改善する。
- [!] **接続エラーの誤検知**: 画面更新時などに「接続が切れました」等のエラーが出ることがある。判定ロジック（現在は5秒？）を調整して誤検知を減らす。
- [!] **在庫推移の可視化（時系列台帳）**: いつ何個増減したかをグラフと表で追える機能。不整合の早期発見と原因特定のため、「在庫台帳」画面を実装する。
- [!] **材料取引履歴の単位統一**: 履歴表示で「個数」なのか「巻数」なのかが不明瞭。「単位」カラムを追加するか、「1巻」のように単位付きで表示して混乱を防ぐ。
- [!] **業者画面(タブレット)のレイアウト改善**: 真ん中の商品選択カラムが狭く、品番が見切れることがある。左右（カテゴリ・カート）を狭めて、中央を広くする。
- [!] **大量数量の入力改善**: ±10ボタンは実装済み。残課題: 数値の直接入力（テンキー）対応、代理入力画面での同等対応。
- [!] **カテゴリー開く/閉じるボタンの視認性**: 現在のバー表示が直感的にわかりにくい。より目立つデザインに改善する。
- [!] **材料スクロールバーの表示位置**: 商品リストのスクロールバーがカート右側に表示される問題。カートのスクロールバーが表示されない/一緒になっている可能性あり。
- [!] **材料持出し確認画面に在庫数表示**: 確認ボタン押下後の確認画面で、各商品の「持出し後の在庫数」を表示して確認してもらう仕様に変更。返品時と同じ仕組みを導入。

### 🟡 機能追加・改善
- [!] **エアコンの棚卸機能**: 毎月の棚卸として実在庫を数え、理論在庫との差異（過不足）を理由とともに記録する機能。材料と同じ仕組みで実装する。
- **エアコン持出し履歴の表示改善**: 差し戻された案件が履歴に残って紛らわしい。「差戻」ステータスを明示するか、履歴から除外する。
- **マニュアル閲覧機能**: 管理画面から `MANUAL_ADMIN.md`、Kioskから `MANUAL_VENDOR.md` を閲覧可能にする。
- **材料在庫連携**: 材料引取で登録した主要4品目を在庫管理と連動させる。
- **Access連携**: 代表メールアドレスを活用する。
- **棚卸中の管理画面**: 業者端末は禁止だが管理画面は使用可能でよいかの検討。
- **エアコン在庫の分離と内機/外機持出し制限**: 室内機/室外機を別々に持出し・返却できる運用への対応。ただし内機・外機を個別に持出せるのは**管理No無し（予備・自社在庫）の場合のみ**に制限する。 通常案件（管理No有り）はセットのみ。
- [!] **エアコン持出しのメモ欄追加**: 新築等の物件情報を記録するためのメモ欄を追加。管理No検索と併用して入力しやすくする。
- **発注管理機能**: 現状は材料・エアコン共に未実装（データベースのみ）。発注書作成→入荷検品→在庫反映の一連のフローを実装する必要がある。
- [ ] **エアコンの予備持ち出し（自社倉庫在庫）**: 「管理Noが決まっていないが、予備として倉庫に持っておきたい」ニーズに対応。「自社在庫（予備）」管理Noまたは「在庫移動モード」の実装。
- [ ] **エアコン持出し情報の直接編集機能**: 「予備」で持ち出した後、案件が決まったら管理Noを紐付けたい。Admin画面に編集ボタンを追加。
- **操作ログの検索機能**: 日付や操作内容でフィルタリング・検索機能。
- [!] **中途半端な材料の返却対応**: 一部を使用して残りを返却するケースに対応（「使用分のみ確定」や「返却処理」）。
- [ ] **業者による返品・在庫訂正処理**: 返品時に実在庫を数えて入力させる「棚卸チェック」付き返品フロー。
- [ ] **ログインセッションの記録**: 端末識別子の記録で操作追跡を可能にする。
- [ ] **画面遷移ガードの実装**: 未ログイン状態でのページアクセスを防止するリダイレクト。
- [ ] **自動ログアウトの担当者記録**: `IdleTimer.tsx` がユーザー情報を渡していない不具合の修正。
- [ ] **ログイン直後のリダイレクト問題**: `AuthGuard` のレースコンディション修正。

### 🟢 将来（会計・インフラ）
- [ ] **与信枠・月次累計発注金額の可視化**: 月初からの累計発注金額を表示し、残与信枠を一目で確認。事前入金で与信枠が増える仕組みに対応。発注管理画面のヘッダーに表示。
- [ ] **自由入力の発注書作成**: 室外機天板・室内機ルーバー等のパーツ注文に対応。品名・数量・単価を手入力で発注書PDFを作成可能にする。
- [ ] **クライアント別単価管理**: 現在の単価は「大東建託パートナーズ」向け。取引先ごとに別単価を管理する仕組み（大東建託新築/大東建託パートナーズ/その他）。
- [ ] **請求締め処理（月次ロック機能）**: 請求書発行後の過去データ変更を防ぐロック機能。
- [ ] **赤黒処理（訂正伝票）**: 締め処理後のデータ修正用マイナス/プラス伝票機能。
- [ ] **棚卸スナップショット**: 月末時点の全商品在庫数と単価を `InventorySnapshot` に保存。
- [ ] **会計ソフト連携エクスポート**: 弥生/freee/MF向けCSV出力。
- [ ] **クラウド移行の検討**: 当面は「方式A（ローカル+バックアップ強化）」を推奨。

---

## 対応済み

- ✅ **バックアップ検証** (2026-02-20): ローカル＋SharePointの両方から復元テスト成功。backup_db.ps1の.env動的読み取り修正済み。
- ✅ **Kioskヘッダー表示改善**: 会社名＋担当者名の表示
- ✅ **エアコン代理入力バッジ**: マルイ紫バッジ「代」表示（材料と統一）
- ✅ **サイドバー並び順統一**: 履歴→先頭、代理入力→末尾に統一
- ✅ **カテゴリ閉じるボタン改善**: サイドバーヘッダーに「◀ カテゴリーを閉じる」バー追加
- ✅ 取引履歴に代理入力バッジ表示（紫色「代理入力」）
- ✅ 商品ごとに代理入力バッジ表示（紫色「代」）
- ✅ 業者選択：テスト業者を最後、よく使う業者を上に表示
- ✅ 価格修正機能（履歴から修正、理由記録、全管理者へメール通知）
- ✅ バックアップ/復旧ドキュメント（docs/BACKUP_RECOVERY.md）
- ✅ 業者有効/無効チェックボックス（Kioskには有効業者のみ表示）
- ✅ 担当者（VendorUser）階層化
- ✅ 担当者の自己登録機能
- ✅ 業者管理の検索クリアボタン追加
- ✅ 新規登録の名前フォント拡大
- ✅ ログの抑制: `next.config.ts` で `/api/health` を除外設定済み
- ✅ PINリセット機能: 管理画面 > 業者管理から担当者PINリセット可能
- ✅ 数量入力の改善: タブレット向けUI実装（±10ボタン、4桁対応）
- ✅ オフライン検知基盤: `offline-alert.tsx` + `checkout-button.tsx` で検知・警告表示済み
- ✅ クリップボードコピー: HTTP環境でのフォールバック実装済み
- ✅ 発注書の項目削除: DRAFT状態の発注から商品を個別削除可能
- ✅ 検索ロジックの共通化: `lib/utils.ts` の `normalizeForSearch` に統一（全8ファイル対応）
- ✅ 発注コピーに品番追加: `[品番] 商品名 × 数量単位` 形式
- ✅ ログインスピナー修正: setTimeout+asyncのレースコンディション解消
- ✅ 確認画面の0件表示バグ修正: Zustand persistのhydration完了まで待機
- ✅ Kioskカートの常時表示: PC/タブレットで3カラムレイアウト化
- ✅ 数量ロジック・表示改善（+10ボタン、巻自動判定、商品種類数表示）
- ✅ ExcelインポートのID対応 & ハイフン許容
- ✅ ログ機能強化（AUTO_LOGOUT/LOGOUT/ADMIN_LOGIN/LOGIN + 担当者名記録）
- ✅ テスト環境の挙動確認: PIN/業者一覧の問題修正済み
