# フィードバック・改善メモ

使用中に気づいた改善点をここに記録してください。
優先度が高いものには `[!]` を付けてください。

> **AIへの指示**: 新しい会話開始時に、このファイルの「未対応」セクションを確認して
> 作業予定を提案すること。

---

## 未対応（優先度順）

###  最優先（データ損失リスク・業務停止回避）
- [!] **検索ロジックの共通化**: 現在、Kiosk/管理画面/商品検索ダイアログで検索処理（全角・半角対応など）がバラバラに実装されている。これを `lib/utils.ts` 等に共通関数として切り出し、メンテナンス性と挙動の統一を図る。
- [!] **オフライン対策の強化**: オフライン検知（`offline-alert.tsx`）は実装済みだが、棚卸中の専用ハンドリング（未送信データの保護・警告）はまだ未対応。
- [!] **ExcelインポートのID対応**: 現状は「品番」で照合しているため、品番変更時に別商品として二重登録されるリスクがある。「ID」による照合に対応し、データ不整合を防ぐ。
- [!] **確認画面の0件表示バグ**: Kioskの最終確認画面で、業者名は出るが「0点」と表示される不具合（履歴には正しく残る）。原因究明が必要。

### ⚠️ 優先（UX・操作性改善）
- [x] **数量入力の改善**: 50個などを入力する際、+ボタン連打は非効率。直接入力または「+5」「+10」ボタンを追加する。（※2026-02-10 タブレット向けUIで実装済み）
- [!] **カート内カテゴリ表示**: カートや確認画面で、カテゴリー・サブカテゴリーを表示して商品間違いを防ぐ。
- [!] **業者のPIN登録/ログインの遅延**: 登録時やログイン時に関数が「もっさり」したり、更新されない場合がある。原因を調査しパフォーマンスを改善する。
- [!] **接続エラーの誤検知**: 画面更新時などに「接続が切れました」等のエラーが出ることがある。判定ロジック（現在は5秒？）を調整して誤検知を減らす。
- [!] **在庫推移の可視化（時系列台帳）**: 今回の調査のように、いつ何個増減したかをグラフと表で追える機能。不整合の早期発見と原因特定のため、「在庫台帳」画面を実装する。
- [!] **カートの常時表示**: 管理画面の「代理入力」と同様に、Kiosk画面でもカートの中身（選択中の商品）が常に見えるようにUIを改善する。現状は見えないため不安がある。
- [!] **大量数量の入力改善**: ±10ボタンは実装済み（`quantity-selector-dialog.tsx`）。残課題: 数値の直接入力（テンキー）対応、代理入力画面での同等対応。

### 📝 機能追加・改善
- **エアコン持出し履歴の表示**: 差し戻された案件が履歴に残って紛らわしい。「差戻」ステータスを明示するか、履歴から除外する。
- ~~**ログの抑制**~~: ✅ `next.config.ts` で `/api/health` を除外設定済み。
- ~~**PINリセット機能**~~: ✅ 管理画面の業者管理から担当者のPINリセットが可能（`vendor-list.tsx`）。
- **マニュアル閲覧機能**:
  - 管理画面から `MANUAL_ADMIN.md` を閲覧可能にする
  - Kiosk画面から `MANUAL_VENDOR.md` を閲覧可能にする
- **材料在庫連携**: 材料引取で登録した主要4品目を在庫管理と連動させる。
- **Access連携**: 代表メールアドレスを活用する。
- **棚卸中の管理画面**: 業者端末は禁止だが管理画面は使用可能でよいかの検討。
- **エアコン在庫の分離**: 室内機/室外機を別々に持ち出し・返却できる運用への対応。
- [!] **エアコンの棚卸機能**: 現在の「在庫調整」ボタンによる場当たり的な変更ではなく、毎月の棚卸として実在庫を数え、理論在庫との差異（過不足）を理由とともに記録する「棚卸機能」を実装し、厳格な在庫管理ができるようにする。
- **発注管理機能**: 現状は材料・エアコン共に未実装（データベースのみ）。発注書作成→入荷検品→在庫反映の一連のフローを実装する必要がある。
- **操作ログの検索機能**: ログが増えてきたため、日付や操作内容でフィルタリング・検索できるようにしたい。
- [!] **中途半端な材料の返却対応**: ペアコイル(1巻20m)や電線などで、一部(10mなど)を使用して残りを返却するイレギュラーなケースに対応する。現在は「1巻持ち出し」で処理されるため在庫がズレてしまう。「使用分のみ確定」や「返却処理」機能の検討が必要。
- [ ] **クラウド移行の検討**: デプロイ計画書（docs/stock-pwa/cloud_deployment_plan.md）に基づき、コストと運用負荷を考慮して移行タイミングを検討。当面は「方式A（ローカル+バックアップ強化）」による低コスト運用を推奨。

---

## 対応済み

- ✅ 取引履歴に代理入力バッジ表示（紫色「代理入力」）
- ✅ 商品ごとに代理入力バッジ表示（紫色「代」）
- ✅ 業者選択：テスト業者を最後、よく使う業者を上に表示
- ✅ 価格修正機能（履歴から修正、理由記録、全管理者へメール通知）
- ✅ バックアップ/復旧ドキュメント（docs/BACKUP_RECOVERY.md）
- ✅ 業者有効/無効チェックボックス（Kioskには有効業者のみ表示）
- ✅ 担当者（VendorUser）階層化
- ✅ 担当者の自己登録機能
- ✅ 業者管理の検索クリアボタン追加
- ✅ 新規登録の名前フォント拡大
- ✅ ログの抑制: `next.config.ts` で `/api/health` を除外設定済み
- ✅ PINリセット機能: 管理画面 > 業者管理から担当者PINリセット可能
- ✅ 数量入力の改善: タブレット向けUI実装（±10ボタン、4桁対応）
- ✅ オフライン検知基盤: `offline-alert.tsx` + `checkout-button.tsx` で検知・警告表示済み
- ✅ クリップボードコピー: HTTP環境でのフォールバック実装済み
- ✅ 発注書の項目削除: DRAFT状態の発注から商品を個別削除可能
