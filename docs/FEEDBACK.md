# フィードバック・改善メモ

使用中に気づいた改善点をここに記録してください。
優先度が高いものには `[!]` を付けてください。

> **AIへの指示**: 新しい会話開始時に、このファイルの「未対応」セクションを確認して
> 作業予定を提案すること。

---

## 未対応（優先度順）

###  最優先（データ損失リスク・業務停止回避）
- [!] ⏰ **【2/20確認】バックアップ検証**: 2/19夜のバックアップが正常に取れたか確認（`backup_db.ps1` の `.env` 動的読み取り修正が正しく機能しているか検証）
- [!] **オフライン対策の強化**: オフライン検知（`offline-alert.tsx`）は実装済みだが、棚卸中の専用ハンドリング（未送信データの保護・警告）はまだ未対応。


- [x] **Kioskヘッダー表示改善**: 作業モード選択画面やヘッダーで、会社名だけでなく担当者名も表示する。

### ⚠️ 優先（UX・操作性改善）
- [!] **同義語・別名検索の対応**: 同じ商品でも呼び方が異なる場合（例: VVF＝VA）やカテゴリ名（例:「電線」）でも検索できるようにエイリアス対応を検討する。
- [ ] **管理番号の重複チェック**: 管理番号(`managementNo`)に紐づけたエアコンの持出しを重複してできないようにする（バリデーション追加）。
- [ ] **在庫破棄・調整機能**: 故障や紛失などで在庫を減らす機能がないため、追加が必要。
- [x] **数量入力の改善**: 50個などを入力する際、+ボタン連打は非効率。直接入力または「+5」「+10」ボタンを追加する。（※2026-02-10 タブレット向けUIで実装済み）
- [!] **カート内カテゴリ表示**: カートや確認画面で、カテゴリー・サブカテゴリーを表示して商品間違いを防ぐ。
- [!] **業者のPIN登録/ログインの遅延**: 登録時やログイン時に関数が「もっさり」したり、更新されない場合がある。原因を調査しパフォーマンスを改善する。
- [!] **接続エラーの誤検知**: 画面更新時などに「接続が切れました」等のエラーが出ることがある。判定ロジック（現在は5秒？）を調整して誤検知を減らす。
- [!] **在庫推移の可視化（時系列台帳）**: 今回の調査のように、いつ何個増減したかをグラフと表で追える機能。不整合の早期発見と原因特定のため、「在庫台帳」画面を実装する。
- [!] **材料取引履歴の単位統一**: 履歴表示で「個数」なのか「巻数」なのかが不明瞭。「単位」カラムを追加するか、「1巻」のように単位付きで表示して混乱を防ぐ。
- [!] **業者画面(タブレット)のレイアウト改善**: 真ん中の商品選択カラムが狭く、品番が見切れることがある。左右（カテゴリ・カート）を狭めて、中央を広くする。
- [!] **テスト環境の挙動確認 (PIN/業者一覧)**: テスト環境(3001)で業者ログイン時に「新しいPIN」を求められる挙動と、業者一覧が全表示される件を確認・修正する。

- [!] **大量数量の入力改善**: ±10ボタンは実装済み（`quantity-selector-dialog.tsx`）。残課題: 数値の直接入力（テンキー）対応、代理入力画面での同等対応。

### 📝 機能追加・改善
- **エアコン持出し履歴の表示**: 差し戻された案件が履歴に残って紛らわしい。「差戻」ステータスを明示するか、履歴から除外する。
- ~~**ログの抑制**~~: ✅ `next.config.ts` で `/api/health` を除外設定済み。
- ~~**PINリセット機能**~~: ✅ 管理画面の業者管理から担当者のPINリセットが可能（`vendor-list.tsx`）。
- **マニュアル閲覧機能**:
  - 管理画面から `MANUAL_ADMIN.md` を閲覧可能にする
  - Kiosk画面から `MANUAL_VENDOR.md` を閲覧可能にする
- **材料在庫連携**: 材料引取で登録した主要4品目を在庫管理と連動させる。
- **Access連携**: 代表メールアドレスを活用する。
- **棚卸中の管理画面**: 業者端末は禁止だが管理画面は使用可能でよいかの検討。
- **エアコン在庫の分離**: 室内機/室外機を別々に持ち出し・返却できる運用への対応。
- [!] **エアコンの棚卸機能**: 現在の「在庫調整」ボタンによる場当たり的な変更ではなく、毎月の棚卸として実在庫を数え、理論在庫との差異（過不足）を理由とともに記録する「棚卸機能」を実装し、厳格な在庫管理ができるようにする。
- **発注管理機能**: 現状は材料・エアコン共に未実装（データベースのみ）。発注書作成→入荷検品→在庫反映の一連のフローを実装する必要がある。
- [ ] **エアコンの予備持ち出し（自社倉庫在庫）**:
    - **要望**: 「管理No（案件）が決まっていないが、予備として自社の倉庫に何台か持っておきたい」というニーズに対応する。
    - **現状**: エアコン持ち出しには「管理No」の入力が必須で、案件紐付けが前提となっている。
    - **対応案**:
        1. 「自社在庫（予備）」という特殊な管理Noを用意して仮押さえする。
        2. または、正規の「在庫移動モード」を実装し、後で案件が決まった際に振替（消し込み）処理を行う。
- [ ] **エアコン持出し情報の直接編集機能**:
    - **要望**: 「予備」で持ち出した後、案件が決まったら管理Noを紐付けたい（いちいち戻して出し直すのは手間）。
    - **現状**: `updateAirconLogInfo` APIは存在するが、画面側(Admin)から呼び出すUIがない。
    - **対応案**: 管理画面のエアコン履歴に「編集」ボタンを追加し、管理Noや顧客名を修正できるようにする。
- **操作ログの検索機能**: ログが増えてきたため、日付や操作内容でフィルタリング・検索できるようにしたい。
- [!] **中途半端な材料の返却対応**: ペアコイル(1巻20m)や電線などで、一部(10mなど)を使用して残りを返却するイレギュラーなケースに対応する。現在は「1巻持ち出し」で処理されるため在庫がズレてしまう。「使用分のみ確定」や「返却処理」機能の検討が必要。
- [ ] **業者による返品・在庫訂正処理 (Inventory Verified Return)**: 
    - 現場から持ち帰った未使用品などを業者が返品できる機能。
    - **業務フロー案**:
        1. 業者がKiosk（または専用モード）で「返品」を選択。
        2. 返品する商品と数量を入力（例: VVF 2.0-3c 1巻）。
        3. システムが「現在の理論在庫数」を表示（例: 現在10巻 + 返品1巻 = **合計11巻** になるはずです）。
        4. 業者が**実在庫を数えて入力**（棚卸チェック）。
        5. **一致する場合**: 単純に「返品（プラス在庫）」として記録。
        6. **不一致の場合**: 「返品（プラス）」と同時に「在庫調整（プラス/マイナス）」データを自動作成し、理由（例: 在庫不整合）を記録する。
    - これにより、「ただ戻すだけ」ではなく「在庫が合っているか確認する」習慣をつけさせる。
- [ ] **ログインセッションの記録**: 現在はネットワーク内での利用が前提だが、複数端末での利用を想定し、ログイン時にセッションIDや端末識別子（Cookie/Local Storage等）を記録して、どの端末での操作か（ログイン～ログアウトの流れ）をログで追跡できるようにする。
- [ ] **画面遷移ガードの実装 (Client-side Route Protection)**: 自動ログアウト後に「材料持出し」などをクリックすると、未ログイン状態で画面に入れてしまう現象が発生。`ShopInterface` や `ModeSelect` 等の保護されたページで、ログイン状態（vendor存在）をチェックし、未ログインなら強制的にトップへリダイレクトする仕組みを実装する。
- [ ] **自動ログアウトの担当者記録**: 自動ログアウト時に「担当者不明」と記録される不具合。`IdleTimer.tsx` が `logAutoLogout` を呼ぶ際にユーザー情報を渡していないため、`vendorUser` も引数に含めて呼び出すよう修正が必要。
- [ ] **自動ログアウトの担当者記録**: 自動ログアウト時に「担当者不明」と記録される不具合。`IdleTimer.tsx` が `logAutoLogout` を呼ぶ際にユーザー情報を渡していないため、`vendorUser` も引数に含めて呼び出すよう修正が必要。
- [ ] **請求締め処理（月次ロック機能）**: 月末に業者への請求額を確定させた後、過去の取引データが変更されないようにロックをかける機能。
    - **必要性**: 請求書発行後に「実は個数が違った」などで過去データを修正してしまうと、システム上の数値と請求書の数値が合わなくなる（監査対応や信頼性の問題）。
    - **実装案**: `MonthlyClosing` テーブルを作成し、「2026年1月度：締済」というレコードがある場合、その期間の `Transaction` に対する変更・削除操作をサーバーサイドでブロックする。修正が必要な場合は、過去データをいじるのではなく「当月で赤黒処理（マイナス伝票）」を入れる運用にする。
- [ ] **赤黒処理（訂正伝票）の実装**: 締め処理後のデータ修正に必要な機能。
    - 過去の誤った取引を取り消すための「マイナス数量の取引」と、正しい「プラス数量の取引」をセットで登録する機能。これにより、在庫と請求金額の整合性を保ちつつ、修正履歴を残すことができる。
- [ ] **棚卸および月末時点在庫の記録（スナップショット）**:
    - 月末時点での「在庫評価額」を確定させるため、締め処理と同時にその時点の全商品の在庫数と単価を別テーブル（`InventorySnapshot`など）に保存する機能。これにより、後から「先月末時点の在庫金額はいくらだったか？」を正確に追跡できる。
- [ ] **会計ソフト連携用エクスポート**:
    - 請求データや仕訳データを、主要な会計ソフト（弥生、freee、MF等）で取り込める形式（CSV）で出力する機能。締め処理とセットで実装することが望ましい。
- [ ] **ログイン直後のリダイレクト問題 (AuthGuard Race Condition)**: 
    - ログイン成功直後に `AuthGuard` が「未ログイン」と判定してトップに戻されている可能性がある。
    - Next.jsのページ遷移(`router.push`)とZustandのステート更新(`setVendor`)のタイミング、またはHydrationの完了待ちロジックを再確認し、遷移前に確実にステートが反映されるように修正する。
    - 一時的な対策として、`AuthGuard` 内で `vendor` が null でも即リダイレクトせず、数ミリ秒待つ、あるいは `verifyPin` 成功時にフラグを立てる等の対策を検討。
- [ ] **クラウド移行の検討**: デプロイ計画書（docs/stock-pwa/cloud_deployment_plan.md）に基づき、コストと運用負荷を考慮して移行タイミングを検討。当面は「方式A（ローカル+バックアップ強化）」による低コスト運用を推奨。

---

## 対応済み

- ✅ 取引履歴に代理入力バッジ表示（紫色「代理入力」）
- ✅ 商品ごとに代理入力バッジ表示（紫色「代」）
- ✅ 業者選択：テスト業者を最後、よく使う業者を上に表示
- ✅ 価格修正機能（履歴から修正、理由記録、全管理者へメール通知）
- ✅ バックアップ/復旧ドキュメント（docs/BACKUP_RECOVERY.md）
- ✅ 業者有効/無効チェックボックス（Kioskには有効業者のみ表示）
- ✅ 担当者（VendorUser）階層化
- ✅ 担当者の自己登録機能
- ✅ 業者管理の検索クリアボタン追加
- ✅ 新規登録の名前フォント拡大
- ✅ ログの抑制: `next.config.ts` で `/api/health` を除外設定済み
- ✅ PINリセット機能: 管理画面 > 業者管理から担当者PINリセット可能
- ✅ 数量入力の改善: タブレット向けUI実装（±10ボタン、4桁対応）
- ✅ オフライン検知基盤: `offline-alert.tsx` + `checkout-button.tsx` で検知・警告表示済み
- ✅ クリップボードコピー: HTTP環境でのフォールバック実装済み
- ✅ 発注書の項目削除: DRAFT状態の発注から商品を個別削除可能
- ✅ 検索ロジックの共通化: `lib/utils.ts` の `normalizeForSearch` に統一（全8ファイル対応）
- ✅ 発注コピーに品番追加: `[品番] 商品名 × 数量単位` 形式でコピー可能に
- ✅ ログインスピナー修正: setTimeout+asyncのレースコンディション解消、5秒フォールバック追加
- ✅ 確認画面の0件表示バグ修正: Zustand persistのhydration完了までローディング表示に変更
- ✅ **Kioskカートの常時表示**: PC/タブレットで3カラムレイアウト化し、カートを右側に固定表示
- ✅ **数量ロジック・表示改善**:
  - +10ボタンの挙動改善（1→10、以降+10）
  - VVF/IV線の「巻」自動判定と表示
  - 「合計点数」を「商品種類数」に変更し、個数と箱数の混在による混乱を解消
  - VVF/IV線の「巻」自動判定と表示
  - 「合計点数」を「商品種類数」に変更し、個数と箱数の混在による混乱を解消
- ✅ **ExcelインポートのID対応 & ハイフン許容**: 
  - インポート時に「ID」列がある場合、IDで商品を特定して更新。
  - **ハイフン対応**: `AP-200-I` のようにハイフン付きで登録可能にしました。
  - **重複防止**: 登録時にハイフンを除去した状態で既存商品（`AP200I`など）と照合し、重複があれば新規作成せず更新します。
- ✅ **ログ機能強化**:
  - `AUTO_LOGOUT`: 自動ログアウト（スリープ復帰時含む）※担当者名も記録
  - `LOGOUT`: 手動ログアウト ※担当者名も記録
  - `ADMIN_LOGIN`: 管理画面ログイン
  - `LOGOUT`: 手動ログアウト ※担当者名も記録
  - `ADMIN_LOGIN`: 管理画面ログイン
  - `LOGIN`: Kiosk PINログイン
  - **ログフォーマット統一**: 会社名＋担当者名に対象を統一




