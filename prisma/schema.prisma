generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Vendor {
  id                 Int                 @id @default(autoincrement())
  name               String
  email              String?
  qrToken            String?             @unique
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  accessCompanyName  String?
  showPriceInEmail   Boolean             @default(true)
  isActive           Boolean             @default(true)
  users              VendorUser[]
  airConditionerLogs AirConditionerLog[]
  transactions       Transaction[]
}

model VendorUser {
  id                 Int                 @id @default(autoincrement())
  name               String // 担当者名
  pinCode            String              @default("1234")
  pinChanged         Boolean             @default(false)
  vendorId           Int
  vendor             Vendor              @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  transactions       Transaction[]
  airConditionerLogs AirConditionerLog[]
}

model Product {
  id             Int                  @id @default(autoincrement())
  code           String               @unique
  name           String
  color          String?
  category       String
  subCategory    String?
  productType    String?
  priceA         Int
  priceB         Int
  priceC         Int                  @default(0)
  cost           Int                  @default(0)
  supplier       String?
  manufacturer   String? // メーカー
  quantityPerBox Int                  @default(1) // 箱入数
  pricePerBox    Int                  @default(0) // 箱単価
  unit           String               @default("個")
  orderUnit      Int                  @default(1)
  stock          Int                  @default(0)
  minStock       Int                  @default(0)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  usageCount     Int                  @default(0)
  countItems     InventoryCountItem[]
  inventoryLogs  InventoryLog[]
  orderItems     OrderItem[]
}

model InventoryLog {
  id        Int      @id @default(autoincrement())
  productId Int
  type      String
  quantity  Int
  reason    String?
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
}

model InventoryCount {
  id        Int                  @id @default(autoincrement())
  status    String               @default("IN_PROGRESS")
  startedAt DateTime             @default(now())
  endedAt   DateTime?
  note      String?
  items     InventoryCountItem[]
}

model InventoryCountItem {
  id            Int            @id @default(autoincrement())
  inventoryId   Int
  productId     Int
  expectedStock Int
  actualStock   Int
  adjustment    Int
  updatedAt     DateTime       @updatedAt
  product       Product        @relation(fields: [productId], references: [id])
  inventory     InventoryCount @relation(fields: [inventoryId], references: [id])

  @@unique([inventoryId, productId])
}

model Transaction {
  id                   Int         @id @default(autoincrement())
  date                 DateTime    @default(now())
  vendorId             Int
  vendorUserId         Int?
  items                String
  hasUnregisteredItems Boolean     @default(false)
  totalAmount          Int
  createdAt            DateTime    @default(now())
  isReturned           Boolean     @default(false)
  returnedAt           DateTime?
  isProxyInput         Boolean     @default(false)
  lastModifiedAt       DateTime?
  vendor               Vendor      @relation(fields: [vendorId], references: [id])
  vendorUser           VendorUser? @relation(fields: [vendorUserId], references: [id])
}

model OperationLog {
  id          Int      @id @default(autoincrement())
  action      String
  target      String
  details     String?
  performedAt DateTime @default(now())
}

model Order {
  id        Int         @id @default(autoincrement())
  supplier  String?
  status    String      @default("DRAFT")
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  items     OrderItem[]
}

model OrderItem {
  id               Int     @id @default(autoincrement())
  orderId          Int
  productId        Int
  quantity         Int
  receivedQuantity Int     @default(0)
  isReceived       Boolean @default(false)
  cost             Int
  product          Product @relation(fields: [productId], references: [id])
  order            Order   @relation(fields: [orderId], references: [id])
}

model AirConditionerLog {
  id              Int            @id @default(autoincrement())
  managementNo    String
  customerName    String?
  contractor      String?
  modelNumber     String
  vendorId        Int
  vendorUserId    Int?
  airconProductId Int?
  isReturned      Boolean        @default(false)
  returnedAt      DateTime?
  createdAt       DateTime       @default(now())
  airconProduct   AirconProduct? @relation(fields: [airconProductId], references: [id])
  vendor          Vendor         @relation(fields: [vendorId], references: [id])
  vendorUser      VendorUser?    @relation(fields: [vendorUserId], references: [id])
}

model AirconProduct {
  id         Int                 @id @default(autoincrement())
  code       String              @unique
  name       String
  capacity   String
  suffix     String              @default("N")
  stock      Int                 @default(0)
  minStock   Int                 @default(0)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  logs       AirConditionerLog[]
  orderItems AirconOrderItem[]
}

model AirconOrder {
  id        Int               @id @default(autoincrement())
  status    String            @default("DRAFT")
  note      String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  items     AirconOrderItem[]
}

model AirconOrderItem {
  id               Int           @id @default(autoincrement())
  orderId          Int
  productId        Int
  quantity         Int
  receivedQuantity Int           @default(0)
  product          AirconProduct @relation(fields: [productId], references: [id])
  order            AirconOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model SystemSetting {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String
}

// 管理者ユーザー
model AdminUser {
  id                 Int      @id @default(autoincrement())
  email              String   @unique
  name               String
  password           String // ハッシュ化されたパスワード
  mustChangePassword Boolean  @default(true) // 初回ログイン時にパスワード変更必須
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}
